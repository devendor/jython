language: java

notifications:
  email:
    recipients:
      - jython-dev@lists.sourceforge.net

install: 
  - ant

os:
  - linux
  - osx

dist: trusty

sudo: false 

env:
  matrix:
    - CUSTOM_JDK="default"
    - CUSTOM_JDK="openjdk7"
    - CUSTOM_JDK="oraclejdk8"
    # oraclejdk7 is no longer supported on travis, but 9 is
    - CUSTOM_JDK="oraclejdk9"

matrix:
  exclude:
     # On OSX, run with default JDK only.
     - os: osx
       env: CUSTOM_JDK="openjdk7"
     - os: osx
       env: CUSTOM_JDK="oraclejdk8"
     - os: osx
       env: CUSTOM_JDK="oraclejdk9"
     # On Linux, run with specific JDKs only.
     - os: linux
       env: CUSTOM_JDK="default"

addons:
   hosts:
      - jytravi
   hostname: jytravi

# newer xcode uses java-10
osx_image: xcode9.3

before_install:
  # Patch for buffer overflow bug, see https://github.com/travis-ci/travis-ci/issues/5227
  # - hostname
  # - cat /etc/hosts # optionally check the content *before*
  #  - sudo hostname "$(hostname | cut -c1-63)"
  # - sed -e "s/^\\(127\\.0\\.0\\.1.*\\)/\\1 $(hostname | cut -c1-63)/" /etc/hosts | sudo tee /etc/hosts
  # - hostname
  # - cat /etc/hosts # optionally check the content *after*
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    export JAVA_HOME=$(/usr/libexec/java_home)
    export PATH=/usr/local/bin:$PATH
    brew update;
    brew install ant;
    which python
    which pip
    pip install Twisted ;
    brew install gnu-sed;
    gsed -i 's#FTP_HOST = .*#FTP_HOST = "ftp://localhost:2121"#' Lib/test/test_urllib2net.py ;
    fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
    jdk_switcher use "$CUSTOM_JDK" ;
    export PATH=$JAVA_HOME/bin:$PATH ;
    sed -i 's#FTP_HOST = .*#FTP_HOST = "ftp://localhost:2121"#' Lib/test/test_urllib2net.py;
    fi
  - twistd  ftp -r $HOME
  - java -version
  - javac -version
  - unset _JAVA_OPTIONS
  - if [ $CUSTOM_JDK == "oraclejdk9" ] ; then export _JAVA_OPTIONS="--illegal-access=warn" JYTHON_OPTS="-J-Dpython.cachedir.skip=true" ; fi


script: ant && ant regrtest-travis

